function AtariScreen(M,N,O,z){function D(){var a=l.getContext("2d");v?(l.width=640,l.height=400,a.setTransform(1,0,0,1,0,0),a.scale(w,x),a.imageSmoothingEnabled=!1):(l.width=p,l.height=r);return a}function A(a){a="undefined"===typeof a?0:a;a=0>a||2<a?0:a;switch(a){case 0:n=4;x=w=2;p=320;r=200;q(new Uint16Array([4095,3840,240,4080,15,3855,255,1365,819,3891,1011,4083,831,3903,1023,0]));break;case 1:n=2;w=1;x=2;p=640;r=200;q(new Uint16Array([4095,3840,240,0]));break;case 2:x=w=n=1,p=640,r=400,q(new Uint16Array([0,
4095]))}var b=D();b.fillStyle=B[0];b.fillRect(0,0,p,r);return E=a}function F(){if(u){u=!1;var a=D(),b=a.createImageData(p,r),c=s.length/n,e=0,d=0,C,f,m,t,g,h=Array(n);for(C=0;C<c;C++){for(f=0;f<n;f++)h[f]=s[d++];for(f=15;-1<f;--f){t=0;g=1<<f;for(m=0;m<n;m++)h[m]&g&&(t+=1<<m);b.data[e++]=k[t][0];b.data[e++]=k[t][1];b.data[e++]=k[t][2];b.data[e++]=255}}a.putImageData(b,0,0);v&&a.drawImage(l,0,0);u=!0}return u}function q(a){var b=a.length;y=Array(b);B=Array(b);k=Array(b);g=Array(b);for(var c=0;c<b;c++)G(c,
a[c])}function G(a,b){var c=(((b&1792)>>7)+((b&2048)>>11)).toString(16),e=(((b&112)>>3)+((b&128)>>7)).toString(16),d=(((b&7)<<1)+((b&8)>>3)).toString(16);y[a]=b;B[a]="#"+c+c+e+e+d+d;k[a]=[parseInt(c+c,16),parseInt(e+e,16),parseInt(d+d,16)]}function H(a,b){for(var c=y.length,e=new Uint16Array(c),d=0;d<c;d++)e[d]=a.getUint16(b),b+=2;q(e)}function I(a,b){for(var c=s.length,e=0;e<c;e++)s[e]=a.getUint16(b),b+=2;return b}function J(a,b){var c=160/n,e=c/2,d,g,f,m,k,h,l;d=new ArrayBuffer(160);var p=new DataView(d),
q=0;for(d=0;d<r;d++){for(g=m=0;g<n;g++)for(k=0;k<c;)if(h=a.getUint8(b++),0<(h&128))for(l=256-h+1,h=a.getUint8(b++),f=0;f<l;f++)p.setUint8(m++,h),k++;else for(h++,f=0;f<h;f++)p.setUint8(m++,a.getUint8(b++)),k++;for(g=m=0;g<e;g++){for(f=0;f<n;f++)s[q+f]=p.getUint16(m+f*c);m+=2;q+=n}}return b}function K(a){var b=!1;if(0<=a&&3>=a){var c=h[a];if(c.on){a=b=c.left_colour;var e=c.right_colour,d=c.position,d=d-c.direction;d>e&&(d=a);d<a&&(d=e);c.position=d;for(var c=c.length,l=0;l<c;l++)d>e&&(d=b),k[a++]=
[g[d][0],g[d][1],g[d++][2]];b=!0}}return b}function L(a){var b=-1;if(0<=a&&3>=a){var c=h[a];0!=c.direction&&(b=c.animationId=setInterval(function(){K(a);requestAnimationFrame(function(){F()})},c.delay),c.animating=!0)}return b}void 0===z&&(z=!0);var y,B,k,g,p,r,E,n,w,x,v=z,u=!0,s=new Uint16Array(16E3),h=[],l=N.appendChild(document.createElement("canvas"));l.id=O;l.width=640;l.height=400;this.width=function(){return p};this.height=function(){return r};this.planes=function(){return n};this.mode=function(){return E};
this.ready=function(){return u};this.palette=y;this.screen_memory=s;this.cycles=h;Object.defineProperty(this,"scale",{get:function(){return v},set:function(a){v=a}});this.SetMode=A;this.Display=F;this.SetPalette=q;this.SetPaletteValue=G;this.ExtractDegasElite=function(a){var b=new DataView(a),c=b.getUint16(0);A(c&255);H(b,2);c=0<(c&32768)?J(b,34):I(b,34);if(32==a.byteLength-c)for(h=[],a=0;4>a;a++){var e={};e.left_colour=b.getUint16(c+2*a);e.right_colour=b.getUint16(c+2*a+8);e.direction=b.getUint16(c+
2*a+16)-1;e.delay=Math.round(1E3*(128-b.getUint16(c+2*a+24))/60);h.push(e)}};this.ExtractPalette=H;this.ExtractPlanarScreen=I;this.ExtractRLEData=J;this.StartCycle=function(a,b){void 0===b&&(b=!1);var c=!1;if(0<=a&&3>=a){var e=h[a];if(0!=e.direction){c=k.length;g=Array(c);for(var d=0;d<c;d++)g[d]=[k[d][0],k[d][1],k[d][2]];e.position=0;e.length=e.right_colour-e.left_colour+1;e.on=!0;b&&L(a);c=!0}}return c};this.GetNextCycle=K;this.StartCycleAnimation=L;this.StopCycle=function(a){var b=!1;if(0<=a&&
3>=a&&(a=h[a],a.on)){a.animating&&clearInterval(a.animationId);a.animating=!1;b=g.length;k=Array(b);for(var c=0;c<b;c++)k[c]=[g[c][0],g[c][1],g[c][2]];a.on=!1;b=!0}return b};A(M)};