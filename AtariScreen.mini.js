function AtariScreen(a,b,d,c){void 0===c&&(c=!0);this.canvas=b.appendChild(document.createElement("canvas"));this.canvas.id=d;this.canvas.width=640;this.canvas.height=400;this.scale=c;this.screen_memory=new Uint16Array(16E3);this.cycles=[];this.mode=this.SetMode(a)}
AtariScreen.prototype.SetMode=function(a){a="undefined"===typeof a?0:a;a=0>a||2<a?0:a;switch(a){case 0:this.planes=4;this.scaleY=this.scaleX=2;this.width=320;this.height=200;this.SetPalette(new Uint16Array([4095,3840,240,4080,15,3855,255,1365,819,3891,1011,4083,831,3903,1023,0]));break;case 1:this.planes=2;this.scaleX=1;this.scaleY=2;this.width=640;this.height=200;this.SetPalette(new Uint16Array([4095,3840,240,0]));break;case 2:this.scaleY=this.scaleX=this.planes=1,this.width=640,this.height=400,
this.SetPalette(new Uint16Array([0,4095]))}return this.mode=a};
AtariScreen.prototype.Display=function(){var a=this.canvas.getContext("2d");this.scale?(this.canvas.width=640,this.canvas.height=400,a.setTransform(1,0,0,1,0,0),a.scale(this.scaleX,this.scaleY),a.imageSmoothingEnabled=!1):(this.canvas.width=this.width,this.canvas.height=this.height);var b=a.createImageData(this.width,this.height),d=this.planes,c=this.screen_memory.length/d,e=0,n=0,k,g,f,h,l=Array(d);for(k=0;k<c;k++){for(g=0;g<d;g++)l[g]=this.screen_memory[n++];for(g=15;-1<g;--g){for(f=h=0;f<d;f++)l[f]&
1<<g&&(h+=1<<f);b.data[e++]=this.pixel_palette[h][0];b.data[e++]=this.pixel_palette[h][1];b.data[e++]=this.pixel_palette[h][2];b.data[e++]=255}}a.putImageData(b,0,0);this.scale&&a.drawImage(this.canvas,0,0)};AtariScreen.prototype.SetPalette=function(a){this.palette=a;this.canvas_palette=Array(a.length);this.pixel_palette=Array(a.length);for(var b=0;b<a.length;b++)this.SetPaletteValue(b,a[b])};
AtariScreen.prototype.SetPaletteValue=function(a,b){var d=(((b&1792)>>7)+((b&2048)>>11)).toString(16),c=(((b&112)>>3)+((b&128)>>7)).toString(16),e=(((b&7)<<1)+((b&8)>>3)).toString(16);this.canvas_palette[a]="#"+d+d+c+c+e+e;this.pixel_palette[a]=[parseInt(d+d,16),parseInt(c+c,16),parseInt(e+e,16)]};
AtariScreen.prototype.ExtractDegasElite=function(a){var b=new DataView(a),d=b.getUint16(0);this.SetMode(d&255);this.ExtractPalette(b,2);d=0<(d&32768)?this.ExtractRLEData(b,34):this.ExtractPlanarScreen(b,34);if(32==a.byteLength-d)for(this.cycles=[],a=0;4>a;a++){var c={};c.left_colour=b.getUint16(d+2*a);c.right_colour=b.getUint16(d+2*a+8);c.direction=b.getUint16(d+2*a+16);c.delay=Math.round(1E3*(128-b.getUint16(d+2*a+24))/60);this.cycles.push(c)}};
AtariScreen.prototype.ExtractPalette=function(a,b){for(var d=this.palette.length,c=new Uint16Array(d),e=0;e<d;e++)c[e]=a.getUint16(b),b+=2;this.SetPalette(c)};AtariScreen.prototype.ExtractPlanarScreen=function(a,b){for(var d=this.screen_memory.length,c=0;c<d;c++)this.screen_memory[c]=a.getUint16(b),b+=2;return b};
AtariScreen.prototype.ExtractRLEData=function(a,b){var d=this.height,c=this.planes,e=160/c,n=e/2,k,g,f,h,l,m,r;k=new ArrayBuffer(160);var p=new DataView(k),q=0;for(k=0;k<d;k++){for(g=h=0;g<c;g++)for(l=0;l<e;)if(m=a.getUint8(b++),0<(m&128))for(r=256-m+1,m=a.getUint8(b++),f=0;f<r;f++)p.setUint8(h++,m),l++;else for(m++,f=0;f<m;f++)p.setUint8(h++,a.getUint8(b++)),l++;for(g=h=0;g<n;g++){for(f=0;f<c;f++)this.screen_memory[q+f]=p.getUint16(h+f*e);h+=2;q+=c}}return b};