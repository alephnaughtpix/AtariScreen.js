class AtariScreen{palette;canvas;canvas_palette;pixel_palette;scale;screen_memory;#a;#b;#c;#d;#e;#f;#g;#h;#i;#j;constructor(e,t,s,i){void 0===i&&(i=!0),this.scale=i,this.#d=!0,this.screen_memory=new Uint16Array(16e3),this.#e=[],this.canvas=t.appendChild(document.createElement("canvas")),this.canvas.id=s,this.canvas.width=640,this.canvas.height=400,this.cycles=this.#e,this.SetMode(e)}#k(){this.canvas.style.visibility="visible"}#l(){this.canvas.style.visibility="hidden"}#m(){var e=this.canvas.getContext("2d");return this.scale?(this.canvas.width=640,this.canvas.height=400,e.setTransform(1,0,0,1,0,0),e.scale(this.#a,this.#b),e.imageSmoothingEnabled=!1):(this.canvas.width=this.#g,this.canvas.height=this.#h),e}#n(){var t=this.#m();t.fillStyle=this.canvas_palette[0],t.fillRect(0,0,this.#g,this.#h)}SetMode(e){switch(e=0>(e=void 0===e?0:e)||e>2?0:e){case 0:this.#j=4,this.#a=2,this.#b=2,this.#g=320,this.#h=200,this.#c=new Uint16Array([4095,3840,240,4080,15,3855,255,1365,819,3891,1011,4083,831,3903,1023,0]),this.SetPalette(this.#c);break;case 1:this.#j=2,this.#a=1,this.#b=2,this.#g=640,this.#h=200,this.#c=new Uint16Array([4095,3840,240,0]),this.SetPalette(this.#c);break;case 2:this.#j=1,this.#a=1,this.#b=1,this.#g=640,this.#h=400,this.#c=new Uint16Array([0,4095]),this.SetPalette(this.#c)}return this.#n(),this.#i=e,e}Display(){if(this.#d){this.#d=!1;var e,t,s,i,a,r,n=this.#m(),h=n.createImageData(this.#g,this.#h),l=this.screen_memory.length/this.#j,c=0,$=0,o=Array(this.#j);for(e=0;e<l;e++){for(s=0;s<this.#j;s++)o[s]=this.screen_memory[$++];for(t=15;t>-1;--t){for(i=0,a=0,r=1<<t;i<this.#j;i++)o[i]&r&&(a+=1<<i);h.data[c++]=this.pixel_palette[a][0],h.data[c++]=this.pixel_palette[a][1],h.data[c++]=this.pixel_palette[a][2],h.data[c++]=255}}n.putImageData(h,0,0),this.scale&&n.drawImage(this.canvas,0,0),this.#d=!0}return this.#d}SetPalette(e){var t=e.length;this.palette=Array(t),this.canvas_palette=Array(t),this.pixel_palette=Array(t),this.#f=Array(t);for(var s=0;s<t;s++)this.SetPaletteValue(s,e[s])}SetPaletteValue(e,t){var s=(((1792&t)>>7)+((2048&t)>>11)).toString(16),i=(((112&t)>>3)+((128&t)>>7)).toString(16),a=(((7&t)<<1)+((8&t)>>3)).toString(16);this.palette[e]=t,this.canvas_palette[e]="#"+s+s+i+i+a+a,this.pixel_palette[e]=[parseInt(s+s,16),parseInt(i+i,16),parseInt(a+a,16)]}ExtractDegasElite(e){var t,s=new DataView(e),i=s.getUint16(0);if(this.SetMode(255&i),this.ExtractPalette(s,2),t=(32768&i)>0?this.ExtractRLEData(s,34):this.ExtractPlanarScreen(s,34),e.byteLength-t==32){this.#e=[];for(var a=0;a<4;a++){var r={};r.left_colour=s.getUint16(t+2*a),r.right_colour=s.getUint16(t+2*a+8),r.direction=s.getUint16(t+2*a+16)-1,r.delay=Math.round((128-s.getUint16(t+2*a+24))*1e3/60),r.position=0,r.length=r.right_colour-r.left_colour+1,r.on=!1,r.animating=!1,this.#e.push(r)}}}ExtractPalette(e,t){for(var s=this.palette.length,i=new Uint16Array(s),a=0;a<s;a++)i[a]=e.getUint16(t),t+=2;this.SetPalette(i)}ExtractPlanarScreen(e,t){for(var s=this.screen_memory.length,i=0;i<s;i++)this.screen_memory[i]=e.getUint16(t),t+=2;return t}ExtractRLEData(e,t){var s,i,a,r,n,h,l,c=160/this.#j,$=c/2,o=new ArrayBuffer(160),p=new DataView(o),u=0;for(s=0;s<this.#h;s++){for(i=0,r=0;i<this.#j;i++)for(n=0;n<c;)if((128&(h=e.getUint8(t++)))>0)for(a=0,l=256-h+1,h=e.getUint8(t++);a<l;a++)p.setUint8(r++,h),n++;else for(h++,a=0;a<h;a++)p.setUint8(r++,e.getUint8(t++)),n++;for(i=0,r=0;i<$;i++){for(a=0;a<this.#j;a++)this.screen_memory[u+a]=p.getUint16(r+a*c);r+=2,u+=this.#j}}return t}StartCycle(e,t){void 0===t&&(t=!1);var s=!1;if(e>=0&&e<=3){var i=this.#e[e];if(0!=i.direction){var a=this.pixel_palette.length;this.#f=Array(a);for(var r=0;r<a;r++)this.#f[r]=[this.pixel_palette[r][0],this.pixel_palette[r][1],this.pixel_palette[r][2]];i.position=0,i.length=i.right_colour-i.left_colour+1,i.on=!0,t&&this.StartCycleAnimation(e),s=!0}}return s}GetNextCycle(e){var t=!1;if(e>=0&&e<=3){var s=this.#e[e];if(s.on){var i=s.left_colour,a=i,r=s.right_colour,n=s.position;(n-=s.direction)>r&&(n=a),n<a&&(n=r),s.position=n;for(var h=s.length,l=0;l<h;l++)n>r&&(n=i),this.pixel_palette[a++]=[this.#f[n][0],this.#f[n][1],this.#f[n++][2]];t=!0}}return t}StartCycleAnimation(e){var t=-1;if(e>=0&&e<=3){var s=this.#e[e];if(0!=s.direction){var i=this;t=s.animationId=setInterval(function(){i.GetNextCycle(e),requestAnimFrame(function(){i.Display()})},s.delay),s.animating=!0}}return t}StopCycle(e){var t=!1;if(e>=0&&e<=3){var s=this.#e[e];if(s.on){s.animating&&clearInterval(s.animationId),s.animating=!1;var i=this.#f.length;pixel_palette=Array(i);for(var a=0;a<i;a++)this.pixel_palette[a]=[this.#f[a][0],this.#f[a][1],this.#f[a][2]];s.on=!1,t=!0}}return t}get canvas(){return this.canvas}set canvas(e){this.canvas=e}get scale(){return this.scale}set scale(e){this.scale=e}get palette(){return this.palette}set palette(e){this.palette=e}get canvas_palette(){return this.canvas_palette}set canvas_palette(e){this.canvas_palette=e}get pixel_palette(){return this.pixel_palette}set pixel_palette(e){this.pixel_palette=e}get screen_memory(){return this.screen_memory}set screen_memory(e){this.screen_memory=e}get cycles(){return this.#e}set cycles(e){this.#e=e}get width(){return this.#g}get height(){return this.#h}get planes(){return this.#j}get mode(){return this.#i}get ready(){return this.#d}get default_palette(){return this.#c}}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)};